FROM ubuntu:22.04

# Set non-interactive frontend to avoid prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# Define build arguments for tool versions
ARG AWSCLI_VERSION=2.15.57
ARG ORAS_VERSION=1.2.0
ARG YQ_VERSION=4.44.3
ARG MAVEN_VERSION=3.9.9
ARG GRADLE_VERSION=8.10.2
ARG SDK_JAVA_IDENTIFIER=21.0.6-amzn
ARG PYTHON_VERSIONS="3.10.15 3.11.10 3.12.7"
ARG NVM_VERSION=0.40.1
ARG NODE_VERSIONS="16.20.2 18.20.4 20.17.0"

# Update package lists and install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    lsb-release \
    tar \
    gzip \
    jq \
    unzip \
    build-essential \
    musl-tools \
    musl-dev \
    pkg-config \
    libssl-dev \
    podman \
    wget \
    zip \
    net-tools \
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Install Rust and cross-compilation targets
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && . $HOME/.cargo/env \
    && rustup target add x86_64-unknown-linux-musl \
    && rustup target add aarch64-unknown-linux-musl

# Set Rust environment variables
ENV PATH="/root/.cargo/bin:${PATH}"

# Install yq with specified version
RUN curl -L "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_$(dpkg --print-architecture)" -o /usr/local/bin/yq \
    && chmod +x /usr/local/bin/yq

# Add Docker's official GPG key
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Set up Docker repository
RUN echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker
RUN apt-get update && apt-get install -y \
    docker-ce \
    docker-ce-cli \
    containerd.io \
    && rm -rf /var/lib/apt/lists/*

# Install Docker Compose
RUN curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose \
    && chmod +x /usr/local/bin/docker-compose

# Install AWS CLI
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-$(uname -m)-${AWSCLI_VERSION}.zip" -o "awscliv2.zip" \
    && unzip awscliv2.zip \
    && ./aws/install \
    && rm -rf awscliv2.zip aws

# Install ORAS
RUN curl -L "https://github.com/oras-project/oras/releases/download/v${ORAS_VERSION}/oras_${ORAS_VERSION}_linux_$(dpkg --print-architecture).tar.gz" -o oras.tar.gz \
    && tar -xzf oras.tar.gz -C /usr/local/bin \
    && rm oras.tar.gz

# Install git-lfs
RUN curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash \
    && apt-get install -y git-lfs

# Install SDKMAN
RUN curl -s "https://get.sdkman.io" -o sdkman-install.sh \
    && bash sdkman-install.sh \
    && rm sdkman-install.sh \
    && bash -c "source /root/.sdkman/bin/sdkman-init.sh && sdk version"

# Install Maven and Gradle using SDKMAN
RUN bash -c "source /root/.sdkman/bin/sdkman-init.sh && sdk install java ${SDK_JAVA_IDENTIFIER}"

RUN bash -c "source /root/.sdkman/bin/sdkman-init.sh && sdk install maven ${MAVEN_VERSION} \
    && sdk install gradle ${GRADLE_VERSION} "

# Ensure SDKMAN is sourced for future sessions
RUN echo "source /root/.sdkman/bin/sdkman-init.sh" >> /root/.bashrc

# Install pyenv dependencies
RUN apt-get update && apt-get install -y \
    git \
    make \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libffi-dev \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# Install pyenv
RUN curl https://pyenv.run | bash

# Set pyenv environment variables
ENV PYENV_ROOT="/root/.pyenv"
ENV PATH="${PYENV_ROOT}/bin:${PYENV_ROOT}/shims:${PATH}"

# Install multiple Python versions
RUN bash -c "for version in ${PYTHON_VERSIONS}; do pyenv install \$version; done"


# Install nvm
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v${NVM_VERSION}/install.sh | bash

# Set nvm environment variables
ENV NVM_DIR="/root/.nvm"
ENV PATH="${NVM_DIR}/versions/node/bin:${PATH}"

# Install multiple Node.js versions
RUN bash -c "source ${NVM_DIR}/nvm.sh && for version in ${NODE_VERSIONS}; do nvm install \$version; done"

# Configure nvm in shell
RUN echo "export NVM_DIR=\"/root/.nvm\"" >> /root/.bashrc && \
    echo "[ -s \"\$NVM_DIR/nvm.sh\" ] && \. \"\$NVM_DIR/nvm.sh\"" >> /root/.bashrc


# Verify installations
RUN docker --version && \
    docker-compose --version && \
    podman --version && \
    aws --version && \
    oras version && \
    yq --version && \
    jq --version && \
    tar --version && \
    gzip --version && \
    rustc --version && \
    cargo --version && \
    git-lfs --version && \
    netstat --version && \
    ssh -V && \
    wget --version && \
    zip --version